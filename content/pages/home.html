<dom-module id="page-home">
  <template>
    <style>
      :host {
        display: none;
      }
      .title {
        padding: 10px 40px 0px 40px;
      }
      .content {
        display: flex;
        align-items: center;
        justify-content: center;
        height: calc(100vh - 140px);
        padding: 0px 20px;
      }
      .menu-items {
        display: flex;
        justify-content: center;
      }
      .menu-item a {
        color: var(--primary-text-color)
      }
      .profile-image {
        text-align: center;
        margin-bottom: 100px;
      }
      .profile-image iron-image {
        border-radius: 100%;
        --iron-image-size: 250px;
        --iron-image-width: var(--iron-image-size);
        --iron-image-height: var(--iron-image-size);
      }
    </style>
    <style include="iron-positioning"></style>

    <div class="title">
      <h1>[[settings.title]]</h1>
    </div>

    Followers [[github.followers]]
    Repos [[github.public_repos]]
    Open Source Projects [[github.my_repos]]

    <div class="content">
      <div>
        <div class="profile-image">
          <iron-image src="https://avatars1.githubusercontent.com/u/6234038?v=4"></iron-image>
        </div>
        <p>
          <type-writer delay="1000" text="Howdy, I'm Jam Risser, a full stack software engineer." speed="80" cursor-duration="3000"></type-writer>
        </p>
        <div class="menu-items">
          <div>
            <template is="dom-repeat" items="[[menuItems]]" as="menuItem">
              <div class="menu-item">
                <h2>
                  <a href="/[[menuItem.slug]]">
                    <type-writer delay="1000" text="[[menuItem.title]]" speed="80" cursor-duration="3000"></type-writer>
                  </a>
                </h2>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div class="content">

  </template>
  <script>
    Polymer({
      is: 'page-home',

      properties: {
        pages: {
          type: Array,
          statePath: 'pages'
        },
        settings: {
          type: Object,
          statePath: 'settings'
        },
        animationConfig: {
          value: function() {
            const themeSettings = app.getThemeSettings();
            return {
              entry: {
                name: themeSettings.pageTransition || 'scale-up-animation',
                node: this
              }
            }
          }
        }
      },

      behaviors: [
        ReduxStateBehavior,
        Polymer.NeonAnimationRunnerBehavior,
      ],

      ready: function() {
        this.set('menuItems', this.getMenuItems());
        this.setGithubInfo();
      },

      attached:  function() {
        this.style.display = 'inline';
        this.playAnimation('entry');
      },

      setGithubInfo: function() {
        var themeSettings = app.getThemeSettings();
        return fetch('https://api.github.com/users/' + themeSettings.githubUser).then((res) => {
          return res.json();
        }).then((body) => {
          this.set('github', body);
        }).then(() => {
          return this.getGithubRepos(themeSettings.githubUser).then((repos) => {
            this.set('github.repos', repos);
          });
        }).then(() => {
          this.set('github.my_repos', _.filter(this.github.repos, (repo) => {
            return repo.owner.login === themeSettings.githubUser;
          }).length);
        });
      },

      getGithubRepos: function(githubUser, repos, page) {
        if (!page) page = 1;
        if (!repos) repos = [];
        return fetch('https://api.github.com/users/' + githubUser + '/repos?page=' + page).then((res) => {
          return res.json();
        }).then((body) => {
          repos = _.flatten([repos, body]);
          if (body.length > 0) return this.getGithubRepos(githubUser, repos, ++page);
          return repos;
        });
      },

      getMenuItems: function() {
        var menuItems = [];
        _.each(this.pages, (page) => {
          if (page.addToMenu) {
            menuItems.push({
              title: page.title,
              slug: page.slug
            });
          }
        });
        return menuItems;
      }
    });
  </script>
</dom-module>
